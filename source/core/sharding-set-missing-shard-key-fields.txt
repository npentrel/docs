.. _shard-key-missing-set:

============================
Set Missing Shard Key Fields
============================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol


To set missing shard key fields, you can use the following operations on
a :binary:`~bin.mongos`:

.. list-table::
   :header-rows: 1
   :widths: 20 20 60

   * - Command
     - Method
     - Description

   * - | :ref:`update <command-update-shard-key-modification>` with
       | ``multi: true``

     - | :ref:`db.collection.updateMany() <updateMany-sharded-collection>`

     - - Can be used to set the missing key value to ``null`` only.

       - Can be performed inside or outside a transaction.

       - Can be performed as a retryable write or not.

       - For additional requirements, refer to the specific
         command/method.

   * - | :ref:`update <command-update-shard-key-modification>`  with 
       | ``multi: false``

     - | :ref:`db.collection.replaceOne() <replaceOne-missing-shard-key>`
       | :ref:`db.collection.updateOne() <updateOne-missing-shard-key>`

     - - Can be used to set the missing key value to ``null`` or any
         other value.

       - To set to a non-``null`` value, :red:`must` be performed either
         inside a transaction or as a retryable write.

       - For additional requirements, refer to the specific
         command/method.

   * - :ref:`findAndModify <cmd-findAndModify-missing-shard-key>`
     - | :ref:`db.collection.findOneAndReplace() <findOneAndReplace-missing-shard-key>`
       | :ref:`db.collection.findOneAndUpdate() <findOneAndUpdate-missing-shard-key>`
       | :ref:`db.collection.findAndModify() <method-findAndModify-missing-shard-key>`

     - - Can be used to set the missing key value to ``null`` or any
         other value.

       - To set to a non-``null`` value, :red:`must` be performed either
         inside a transaction or as a retryable write.

       - :red:`Must` include an equality condition on the shard key in
         the query filter. Missing key values are returned when matching
         on ``null``. To avoid updating a key value that is ``null``,
         include additional query conditions as appropriate.

       - For additional requirements, refer to the specific
         command/method.

   * -
     - | :method:`db.collection.bulkWrite()`
       | :method:`Bulk.find.replaceOne()`
       | :method:`Bulk.find.updateOne()`
       | :method:`Bulk.find.update()`

     - - To set to a ``null`` value,  you can specify multiple shard
         key modifications in the bulk operation.

       - To set to a non-``null`` value, you can specify a single shard
         key modification in the bulk operation; batch size must be 1.

       - To set to a non-``null`` value, the operation :red:`must` be
         performed either inside a transaction or as a retryable write.

       - For additional requirements, refer to the underlying
         command/method.

Once you have set the shard key field, you can :ref:`modify the field's
value <update-shard-key>`.

Example
-------

Consider a ``sales`` collection which is sharded on the ``location``
field. Some documents in the collection have no ``location`` field. To
be able to :ref:`modify the shard key value <update-shard-key>` for a
specific document, you first need to set the shard key value to null:

.. code-block:: javascript

   db.sales.updateOne({ _id: 12345 }, { $set: { location: null } })
